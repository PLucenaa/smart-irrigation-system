name: ğŸš€ Deploy to VPS (Debian + Docker)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-backend:
    name: ğŸ”¨ Build Backend (Spring Boot)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Setup Java ${{ secrets.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ secrets.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ”§ Build com Maven
        working-directory: ./fullstack-irrigation/api-irrigacao
        run: |
          mvn clean package -DskipTests
          echo "âœ… Build do backend concluÃ­do"

      - name: ğŸ“¦ Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-jar
          path: fullstack-irrigation/api-irrigacao/target/*.jar
          retention-days: 1

  build-frontend:
    name: ğŸ¨ Build Frontend (React)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js ${{ secrets.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ secrets.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: fullstack-irrigation/dashboard-irrigacao/package-lock.json

      - name: ğŸ“¥ Instalar dependÃªncias
        working-directory: ./fullstack-irrigation/dashboard-irrigacao
        run: npm ci

      - name: ğŸ”§ Build produÃ§Ã£o
        working-directory: ./fullstack-irrigation/dashboard-irrigacao
        run: |
          npm run build
          echo "âœ… Build do frontend concluÃ­do"

      - name: ğŸ“¦ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-build
          path: fullstack-irrigation/dashboard-irrigacao/dist
          retention-days: 1

  deploy:
    name: ğŸš€ Deploy no VPS (Debian)
    needs: [ build-backend, build-frontend ]
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ğŸ” Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: ğŸš€ Deploy no VPS
        timeout-minutes: 10
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_BACKEND_DIR: ${{ secrets.VPS_BACKEND_DIR }}
          VPS_FRONTEND_DIR: ${{ secrets.VPS_FRONTEND_DIR }}
        run: |
          # ConfiguraÃ§Ãµes SSH otimizadas (mesmas do teste que funcionou)
          SSH_OPTS="-o StrictHostKeyChecking=no \
                    -o ConnectTimeout=30 \
                    -o ServerAliveInterval=10 \
                    -o ServerAliveCountMax=3 \
                    -o TCPKeepAlive=yes"

          # Testar conexÃ£o primeiro
          echo "ğŸ” Testando conexÃ£o SSH..."
          ssh $SSH_OPTS $VPS_USER@$VPS_HOST "echo 'âœ… ConexÃ£o OK'" || {
            echo "âŒ Falha na conexÃ£o SSH"
            exit 1
          }

          # Criar diretÃ³rios
          echo "ğŸ“ Criando diretÃ³rios..."
          ssh $SSH_OPTS $VPS_USER@$VPS_HOST "mkdir -p $VPS_BACKEND_DIR /tmp/dashboard-build && rm -rf /tmp/dashboard-build/*"

          # Copiar JAR
          echo "ğŸ“¦ Copiando JAR..."
          JAR_NAME=$(basename ./artifacts/api-jar/*.jar)
          scp $SSH_OPTS ./artifacts/api-jar/*.jar $VPS_USER@$VPS_HOST:$VPS_BACKEND_DIR/$JAR_NAME

          # Renomear JAR se necessÃ¡rio
          ssh $SSH_OPTS $VPS_USER@$VPS_HOST << ENDSSH
            if [ -f "$VPS_BACKEND_DIR/$JAR_NAME" ] && [ "$JAR_NAME" != "api-irrigacao-0.0.1-SNAPSHOT.jar" ]; then
              if [ -f "$VPS_BACKEND_DIR/api-irrigacao-0.0.1-SNAPSHOT.jar" ]; then
                mv $VPS_BACKEND_DIR/api-irrigacao-0.0.1-SNAPSHOT.jar $VPS_BACKEND_DIR/api-irrigacao-0.0.1-SNAPSHOT.jar.backup.\$(date +%Y%m%d_%H%M%S)
              fi
              mv $VPS_BACKEND_DIR/$JAR_NAME $VPS_BACKEND_DIR/api-irrigacao-0.0.1-SNAPSHOT.jar
            fi
          ENDSSH

          # Copiar frontend (usando mÃ©todo mais robusto)
          echo "ğŸ“¦ Copiando frontend..."
          # Primeiro, garantir que o diretÃ³rio existe e estÃ¡ vazio
          ssh $SSH_OPTS $VPS_USER@$VPS_HOST "rm -rf /tmp/dashboard-build && mkdir -p /tmp/dashboard-build"
          
          # Copiar todos os arquivos e diretÃ³rios
          scp -r $SSH_OPTS \
            ./artifacts/dashboard-build/. \
            $VPS_USER@$VPS_HOST:/tmp/dashboard-build/

          # Mover frontend para Nginx
          ssh $SSH_OPTS $VPS_USER@$VPS_HOST << ENDSSH
            sudo rm -rf $VPS_FRONTEND_DIR/*
            sudo mv /tmp/dashboard-build/* $VPS_FRONTEND_DIR/
            sudo chown -R www-data:www-data $VPS_FRONTEND_DIR
            sudo chmod -R 755 $VPS_FRONTEND_DIR
            echo "âœ… Frontend atualizado"
          ENDSSH

          # Reiniciar serviÃ§os
          ssh $SSH_OPTS $VPS_USER@$VPS_HOST << 'ENDSSH'
            # Verificar Docker
            if docker ps --format '{{.Names}}' | grep -q "smart-irrigation"; then
              echo "âœ… Container PostgreSQL rodando"
            fi

            # Reiniciar Spring Boot
            if systemctl list-unit-files 2>/dev/null | grep -q "api-irrigacao.service"; then
              if systemctl is-active --quiet api-irrigacao; then
                echo "ğŸ”„ Reiniciando api-irrigacao..."
                sudo systemctl restart api-irrigacao
                sleep 2
              else
                sudo systemctl start api-irrigacao
              fi
            fi

            # Recarregar Nginx
            if sudo nginx -t 2>/dev/null; then
              sudo systemctl reload nginx
              echo "âœ… Nginx recarregado"
            else
              echo "âŒ Erro no Nginx"
              exit 1
            fi
          ENDSSH

      - name: âœ… Verificar deploy
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          echo "âœ… Deploy concluÃ­do!"
          echo "ğŸŒ https://$VPS_HOST"