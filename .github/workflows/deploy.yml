name: ğŸš€ Deploy to VPS (Debian + Docker)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-backend:
    name: ğŸ”¨ Build Backend (Spring Boot)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Setup Java ${{ secrets.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ secrets.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ”§ Build com Maven
        working-directory: ./fullstack-irrigation/api-irrigacao
        run: |
          mvn clean package -DskipTests
          echo "âœ… Build do backend concluÃ­do"

      - name: ğŸ“¦ Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-jar
          path: fullstack-irrigation/api-irrigacao/target/*.jar
          retention-days: 1

  build-frontend:
    name: ğŸ¨ Build Frontend (React)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js ${{ secrets.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ secrets.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: fullstack-irrigation/dashboard-irrigacao/package-lock.json

      - name: ğŸ“¥ Instalar dependÃªncias
        working-directory: ./fullstack-irrigation/dashboard-irrigacao
        run: npm ci

      - name: ğŸ”§ Build produÃ§Ã£o
        working-directory: ./fullstack-irrigation/dashboard-irrigacao
        run: |
          npm run build
          echo "âœ… Build do frontend concluÃ­do"

      - name: ğŸ“¦ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-build
          path: fullstack-irrigation/dashboard-irrigacao/dist
          retention-days: 1

  deploy:
    name: ğŸš€ Deploy no VPS (via Webhook)
    needs: [ build-backend, build-frontend ]
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ğŸš€ Notificar VPS para deploy
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_WEBHOOK_TOKEN }}
        run: |
          # Envia webhook para o VPS executar o deploy
          curl -X POST "http://$VPS_HOST:8081/deploy" \
            -H "Authorization: Bearer $DEPLOY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"action":"deploy"}' \
            --max-time 30 \
            || echo "âš ï¸ Webhook nÃ£o disponÃ­vel, deploy manual necessÃ¡rio"

      - name: âœ… Verificar deploy
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          echo "âœ… Deploy iniciado via webhook!"
          echo "ğŸŒ Frontend: https://$VPS_HOST"
          echo "ğŸ”Œ API: https://$VPS_HOST/api/leituras"