name: ğŸš€ Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  # ============================================================================
  # JOB 1: Build e Testes do Backend (Spring Boot)
  # ============================================================================
  build-backend:
    name: ğŸ”¨ Build Backend (Spring Boot)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Setup Java ${{ secrets.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ secrets.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ”§ Build com Maven
        working-directory: ./fullstack-irrigation/api-irrigacao
        run: |
          mvn clean package -DskipTests=false
          echo "âœ… Build do backend concluÃ­do"

      - name: ğŸ“¦ Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-jar
          path: fullstack-irrigation/api-irrigacao/target/*.jar
          retention-days: 1

  # ============================================================================
  # JOB 2: Build do Frontend (React)
  # ============================================================================
  build-frontend:
    name: ğŸ¨ Build Frontend (React)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js ${{ secrets.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ secrets.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: fullstack-irrigation/dashboard-irrigacao/package-lock.json

      - name: ğŸ“¥ Instalar dependÃªncias
        working-directory: ./fullstack-irrigation/dashboard-irrigacao
        run: npm ci

      - name: ğŸ”§ Build produÃ§Ã£o
        working-directory: ./fullstack-irrigation/dashboard-irrigacao
        run: |
          npm run build
          echo "âœ… Build do frontend concluÃ­do"

      - name: ğŸ“¦ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-build
          path: fullstack-irrigation/dashboard-irrigacao/dist
          retention-days: 1

  # ============================================================================
  # JOB 3: Deploy no VPS
  # ============================================================================
  deploy:
    name: ğŸš€ Deploy no VPS
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ğŸ” Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: ğŸš€ Deploy no VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_BACKEND_DIR: ${{ secrets.VPS_BACKEND_DIR }}
          VPS_FRONTEND_DIR: ${{ secrets.VPS_FRONTEND_DIR }}
        run: |
          # Cria diretÃ³rios no VPS se nÃ£o existirem
          ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << ENDSSH
            mkdir -p $VPS_BACKEND_DIR
            mkdir -p $VPS_FRONTEND_DIR
          ENDSSH

          # Copia o JAR do backend para /root/api-irrigacao
          echo "ğŸ“¦ Copiando JAR para $VPS_BACKEND_DIR..."
          scp -o StrictHostKeyChecking=no \
            ./artifacts/api-jar/*.jar \
            $VPS_USER@$VPS_HOST:$VPS_BACKEND_DIR/api-irrigacao.jar

          # Copia o build do frontend para /var/www/dashboard
          echo "ğŸ“¦ Copiando frontend para $VPS_FRONTEND_DIR..."
          ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST \
            "sudo rm -rf $VPS_FRONTEND_DIR/*"
          
          # Copia arquivos temporariamente para um local com permissÃ£o
          scp -r -o StrictHostKeyChecking=no \
            ./artifacts/dashboard-build/* \
            $VPS_USER@$VPS_HOST:/tmp/dashboard-build/

          # Move com sudo para o diretÃ³rio final
          ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << ENDSSH
            sudo mv /tmp/dashboard-build/* $VPS_FRONTEND_DIR/
            sudo chown -R www-data:www-data $VPS_FRONTEND_DIR
            sudo chmod -R 755 $VPS_FRONTEND_DIR
          ENDSSH

          # Reinicia o serviÃ§o Spring Boot (se existir)
          echo "ğŸ”„ Reiniciando serviÃ§o Spring Boot..."
          ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << ENDSSH || echo "âš ï¸ ServiÃ§o systemd nÃ£o encontrado, pulando reinicializaÃ§Ã£o"
            if systemctl is-active --quiet api-irrigacao 2>/dev/null; then
              sudo systemctl restart api-irrigacao
              echo "âœ… ServiÃ§o api-irrigacao reiniciado"
            else
              echo "â„¹ï¸ ServiÃ§o api-irrigacao nÃ£o estÃ¡ configurado como systemd"
            fi
          ENDSSH

          # Recarrega Nginx
          echo "ğŸŒ Recarregando Nginx..."
          ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << ENDSSH
            if sudo nginx -t; then
              sudo systemctl reload nginx
              echo "âœ… Nginx recarregado"
            else
              echo "âŒ Erro na configuraÃ§Ã£o do Nginx"
              exit 1
            fi
          ENDSSH

      - name: âœ… Verificar deploy
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          echo "âœ… Deploy concluÃ­do com sucesso!"
          echo "ğŸŒ Frontend: https://$VPS_HOST"
          echo "ğŸ”Œ API: https://$VPS_HOST/api/leituras"